
packages:
  - yaml
  - whisker
  - dplyr
  - tidyr
  - meddle
  - readr
  - httr
  - rgdal
  - stringr
  - glmtools
  - sp
  - RJSONIO
  - sbtools
  - RcppCNPy
  - purrr

sources:
  - src/spatial_utils.R
  - src/file_utils.R

targets:
  all:
    depends:
      - spatial_sb_id
      - parent_sb_id
      - config_sb_id
      - inputs_sb_id
      - train_parent_sb_id
      - train_68_sb_id
      - train_sp_sb_id
      - train_me_sb_id
      - predict_me_sb_id
      - predict_sp_sb_id

  lake_ids:
    command: read_csv("in/model_lake_ids.csv")

  modeled_lakes:
    command: subset_save_winslow(lake_ids)

  in/model_lakes_attrs.csv:
    command: attribute_skeleton(modeled_lakes, attr.file = target_name)

  generic_text:
    command: yaml.load_file("in/text_SHARED.yml")

  release_text:
    command: yaml.load_file("in/text_release.yml")

  inputs_text:
    command: yaml.load_file("in/text_drivers.yml")

  glm_config_text:
    command: yaml.load_file("in/text_GLM_config.yml")

  spatial_text:
    command: >
      list(title = I('Spatial data: Process-guided deep learning predictions of lake water temperature'))

  training_text:
    command: >
      list(title = I('Training data: Process-guided deep learning predictions of lake water temperature'))

  me_training_text:
    command: >
      list(title = I('Lake Mendota detailed  training data: Process-guided deep learning predictions of lake water temperature'))

  sp_training_text:
    command: >
      list(title = I('Sparkling Lake detailed training data: Process-guided deep learning predictions of lake water temperature'))

  all_lakes_historical_training_text:
    command: yaml.load_file('in/text_training_all_lakes.yml')

  lakes_metadata:
    command: as.attr_list("in/model_lakes_attrs.csv")

  mendota_lake:
    command: subset_spatial(modeled_lakes, site_id = I('nhd_13293262'))

  sparkling_lake:
    command: subset_spatial(modeled_lakes, site_id = I('nhd_13344210'))

  me_spatial_metadata:
    command: extract_feature(mendota_lake)

  sp_spatial_metadata:
    command: extract_feature(sparkling_lake)

  spatial_metadata:
    command: extract_feature(modeled_lakes)

  out/release.xml:
    command: render(filename = target_name, generic_text, release_text, spatial_metadata)

  out/spatial.xml:
    command: render(filename = target_name, generic_text, spatial_text, lakes_metadata, spatial_metadata)

  out/spatial.zip:
    command: sp_to_zip(target_name, modeled_lakes)

  out/inputs.xml:
    command: render(filename = target_name, generic_text, inputs_text, spatial_metadata)

  out/meteo_inputs.zip:
    command: bundle_meteo_files(target_name, lake_ids, pattern = I('_meteo.csv'))

  out/glm_config.xml:
    command: render(filename = target_name, generic_text, glm_config_text, spatial_metadata)

  out/glm_config.json:
    command: bundle_nml_files(target_name, lake_ids, pattern = I('_nml.nml'))

  out/training.xml:
    command: render(filename = target_name, generic_text, training_text, spatial_metadata)

  out/training_mendota.xml:
    command: render(filename = target_name, generic_text, me_training_text, me_spatial_metadata)

  out/training_sparkling.xml:
    command: render(filename = target_name, generic_text, sp_training_text, sp_spatial_metadata)

  out/training_all_historical.xml:
    command: render(filename = target_name, generic_text, all_lakes_historical_training_text, spatial_metadata)

  out/all_lakes_historical_training.csv:
    command: merge_obs_files(target_name, lake_ids, pattern = I('_train_all_profiles.csv'))

  out/me_season_training.csv:
    command: merge_single_lake_obs_files(target_name, pattern = I('me_season_train_500_profiles'), dir = I("../fig_2/yeti_sync/"))

  out/sp_season_training.csv:
    command: merge_single_lake_obs_files(target_name, pattern = I('sp_season_train_500_profiles'), dir = I("../fig_2/yeti_sync/"))

  out/me_year_training.csv:
    command: merge_single_lake_obs_files(target_name, pattern = I('me_year_train_500_profiles'), dir = I("../fig_2/yeti_sync/"))

  out/sp_year_training.csv:
    command: merge_single_lake_obs_files(target_name, pattern = I('sp_year_train_500_profiles'), dir = I("../fig_2/yeti_sync/"))

  out/sp_similar_training.csv:
    command: merge_single_lake_obs_files(target_name, pattern = I('sp_similar_train_500_profiles'), dir = I("../fig_2/yeti_sync/"))

  out/me_similar_training.csv:
    command: merge_single_lake_obs_files(target_name, pattern = I('me_train_[0159]'), dir = I("../fig_1/yeti_sync/"))

  # convert "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/PGRNN_mendota_exp3_02.npy" into
  # "me_similar_predict_pgdl.csv" with added columns for exper_n = int, exper_id = "similar_%s" n_profiles
  out/me_similar_predict_pgdl.csv:
    command: combine_XJ_npy_similar(target_name, n_depths = 50,
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/PGRNN_mendota_exp1_02.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/PGRNN_mendota_exp1_10.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/PGRNN_mendota_exp1_100.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/PGRNN_mendota_exp1_50.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/PGRNN_mendota_exp1_500.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/PGRNN_mendota_exp1_980.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/PGRNN_mendota_exp2_02.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/PGRNN_mendota_exp2_10.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/PGRNN_mendota_exp2_100.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/PGRNN_mendota_exp2_50.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/PGRNN_mendota_exp2_500.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/PGRNN_mendota_exp2_980.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/PGRNN_mendota_exp3_02.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/PGRNN_mendota_exp3_10.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/PGRNN_mendota_exp3_100.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/PGRNN_mendota_exp3_50.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/PGRNN_mendota_exp3_500.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/PGRNN_mendota_exp3_980.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/PGRNN_mendota_exp4_02.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/PGRNN_mendota_exp4_10.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/PGRNN_mendota_exp4_100.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/PGRNN_mendota_exp4_50.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/PGRNN_mendota_exp4_500.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/PGRNN_mendota_exp4_980.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/PGRNN_mendota_exp5_02.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/PGRNN_mendota_exp5_10.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/PGRNN_mendota_exp5_100.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/PGRNN_mendota_exp5_50.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/PGRNN_mendota_exp5_500.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/PGRNN_mendota_exp5_980.npy")

  out/me_similar_predict_dl.csv:
    command: combine_XJ_npy_similar(target_name, n_depths = 50,
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/RNN_mendota_exp1_10.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/RNN_mendota_exp1_100.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/RNN_mendota_exp1_50.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/RNN_mendota_exp1_500.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/RNN_mendota_exp1_980.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/RNN_mendota_exp2_10.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/RNN_mendota_exp2_100.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/RNN_mendota_exp2_50.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/RNN_mendota_exp2_500.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/RNN_mendota_exp2_980.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/RNN_mendota_exp3_10.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/RNN_mendota_exp3_100.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/RNN_mendota_exp3_50.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/RNN_mendota_exp3_500.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/RNN_mendota_exp3_980.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/RNN_mendota_exp4_10.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/RNN_mendota_exp4_100.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/RNN_mendota_exp4_50.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/RNN_mendota_exp4_500.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/RNN_mendota_exp4_980.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/RNN_mendota_exp5_10.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/RNN_mendota_exp5_100.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/RNN_mendota_exp5_50.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/RNN_mendota_exp5_500.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_1/in/RNN_mendota_exp5_980.npy")

  out/me_season_predict_pgdl.csv:
    command: combine_XJ_npy_other(target_name, n_depths = 50,
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_2/in/PGRNN_mendota_season_exp1.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_2/in/PGRNN_mendota_season_exp2.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_2/in/PGRNN_mendota_season_exp3.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_2/in/PGRNN_mendota_season_exp4.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_2/in/PGRNN_mendota_season_exp5.npy")

  out/me_season_predict_dl.csv:
    command: combine_XJ_npy_other(target_name, n_depths = 50,
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_2/in/RNN_mendota_season_exp1.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_2/in/RNN_mendota_season_exp2.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_2/in/RNN_mendota_season_exp3.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_2/in/RNN_mendota_season_exp4.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_2/in/RNN_mendota_season_exp5.npy")

  out/me_year_predict_pgdl.csv:
    command: combine_XJ_npy_other(target_name, n_depths = 50,
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_2/in/PGRNN_mendota_year_exp1.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_2/in/PGRNN_mendota_year_exp2.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_2/in/PGRNN_mendota_year_exp3.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_2/in/PGRNN_mendota_year_exp4.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_2/in/PGRNN_mendota_year_exp5.npy")

  out/me_year_predict_dl.csv:
    command: combine_XJ_npy_other(target_name, n_depths = 50,
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_2/in/RNN_mendota_year_exp1.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_2/in/RNN_mendota_year_exp2.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_2/in/RNN_mendota_year_exp3.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_2/in/RNN_mendota_year_exp4.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_2/in/RNN_mendota_year_exp5.npy")

  out/sp_similar_predict_pgdl.csv:
    command: combine_XJ_npy_other(target_name, n_depths = 37,
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_2/in/PGRNN_similar_sparkling_exp1.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_2/in/PGRNN_similar_sparkling_exp2.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_2/in/PGRNN_similar_sparkling_exp3.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_2/in/PGRNN_similar_sparkling_exp4.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_2/in/PGRNN_similar_sparkling_exp5.npy")

  out/sp_similar_predict_dl.csv:
    command: combine_XJ_npy_other(target_name, n_depths = 37,
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_2/in/RNN_similar_sparkling_exp1.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_2/in/RNN_similar_sparkling_exp2.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_2/in/RNN_similar_sparkling_exp3.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_2/in/RNN_similar_sparkling_exp4.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_2/in/RNN_similar_sparkling_exp5.npy")

  out/sp_season_predict_pgdl.csv:
    command: combine_XJ_npy_other(target_name, n_depths = 37,
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_2/in/PGRNN_season_sparkling_exp1.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_2/in/PGRNN_season_sparkling_exp2.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_2/in/PGRNN_season_sparkling_exp3.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_2/in/PGRNN_season_sparkling_exp4.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_2/in/PGRNN_season_sparkling_exp5.npy")

  out/sp_season_predict_dl.csv:
    command: combine_XJ_npy_other(target_name, n_depths = 37,
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_2/in/RNN_season_sparkling_exp1.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_2/in/RNN_season_sparkling_exp2.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_2/in/RNN_season_sparkling_exp3.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_2/in/RNN_season_sparkling_exp4.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_2/in/RNN_season_sparkling_exp5.npy")

  out/sp_year_predict_pgdl.csv:
    command: combine_XJ_npy_other(target_name, n_depths = 37,
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_2/in/PGRNN_year_sparkling_exp1.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_2/in/PGRNN_year_sparkling_exp2.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_2/in/PGRNN_year_sparkling_exp3.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_2/in/PGRNN_year_sparkling_exp4.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_2/in/PGRNN_year_sparkling_exp5.npy")

  out/sp_year_predict_dl.csv:
    command: combine_XJ_npy_other(target_name, n_depths = 37,
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_2/in/RNN_year_sparkling_exp1.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_2/in/RNN_year_sparkling_exp2.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_2/in/RNN_year_sparkling_exp3.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_2/in/RNN_year_sparkling_exp4.npy",
      "/Users/jread/Documents/R/ms-pgdl-wrr/fig_2/in/RNN_year_sparkling_exp5.npy")


  parent_sb_id:
    command: sb_replace_files(I('5d88ea50e4b0c4f70d0ab3c0'), 'out/release.xml')

  config_sb_id:
    command: sb_replace_files(I('5d8a2257e4b0c4f70d0ae513'), 'out/glm_config.xml', 'out/glm_config.json')

  inputs_sb_id:
    command: sb_replace_files(I('5d89d90ce4b0c4f70d0ae4df'), 'out/inputs.xml','out/meteo_inputs.zip')

  train_parent_sb_id:
    command: sb_replace_files(I('5d8a42e3e4b0c4f70d0ae5fd'), 'out/training.xml')

  train_68_sb_id:
    command: sb_replace_files(I('5d8a47bce4b0c4f70d0ae61f'), 'out/training_all_historical.xml', 'out/all_lakes_historical_training.csv')

  train_sp_sb_id:
    command: sb_replace_files(I('5d8a4752e4b0c4f70d0ae61a'),
      'out/training_sparkling.xml',
      'out/sp_season_training.csv',
      'out/sp_similar_training.csv',
      'out/sp_year_training.csv')

  train_me_sb_id:
    command: sb_replace_files(I('5d8a837fe4b0c4f70d0ae8ac'),
      'out/training_mendota.xml',
      'out/me_season_training.csv',
      'out/me_similar_training.csv',
      'out/me_year_training.csv')

  # need me_predict .xml written and added...
  predict_me_sb_id:
    command: sb_replace_files(I('5d915cb2e4b0c4f70d0ce523'),
      'out/me_similar_predict_pgdl.csv',
      'out/me_similar_predict_dl.csv',
      'out/me_season_predict_pgdl.csv',
      'out/me_season_predict_dl.csv',
      'out/me_year_predict_pgdl.csv',
      'out/me_year_predict_dl.csv')

  # need me_predict .xml written and added...
  predict_sp_sb_id:
    command: sb_replace_files(I('5d915cc6e4b0c4f70d0ce525'),
      'out/sp_similar_predict_pgdl.csv',
      'out/sp_similar_predict_dl.csv',
      'out/sp_season_predict_pgdl.csv',
      'out/sp_season_predict_dl.csv',
      'out/sp_year_predict_pgdl.csv',
      'out/sp_year_predict_dl.csv')

  spatial_sb_id:
    command: sb_replace_files(I('5d89d8e3e4b0c4f70d0ae4dc'), 'out/spatial.xml', 'out/spatial.zip')
