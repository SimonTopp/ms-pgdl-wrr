
include:
  - 3_model_inputs.yml
  - 4_model_training.yml
  - 6_model_evaluation.yml

packages:
  - yaml
  - whisker
  - dplyr
  - tidyr
  - meddle
  - readr
  - feather
  - httr
  - rgdal
  - stringr
  - glmtools
  - sp
  - RJSONIO
  - sbtools
  - RcppCNPy
  - purrr

sources:
  - src/spatial_utils.R
  - src/file_utils.R

targets:
  all:
    depends:
      - spatial_sb_id
      - parent_sb_id
      - config_sb_id
      - inputs_sb_id
      - train_parent_sb_id
      - train_68_sb_id
      - train_sp_sb_id
      - train_me_sb_id
      - predict_me_sb_id
      - predict_sp_sb_id


  generic_text:
    command: yaml.load_file("in/text_SHARED.yml")

  release_text:
    command: yaml.load_file("in/text_release.yml")

  out/release.xml:
    command: render(filename = target_name, generic_text, release_text, spatial_metadata)

  out/spatial.xml:
    command: render(filename = target_name, generic_text, spatial_text, lakes_metadata, spatial_metadata)

  out/inputs.xml:
    command: render(filename = target_name, generic_text, inputs_text, spatial_metadata)

  out/glm_config.xml:
    command: render(filename = target_name, generic_text, glm_config_text, spatial_metadata)


  out/training.xml:
    command: render(filename = target_name, generic_text, training_text, spatial_metadata)

  out/training_mendota.xml:
    command: render(filename = target_name, generic_text, me_training_text, me_spatial_metadata)

  out/training_sparkling.xml:
    command: render(filename = target_name, generic_text, sp_training_text, sp_spatial_metadata)

  out/training_all_historical.xml:
    command: render(filename = target_name, generic_text, all_lakes_historical_training_text, spatial_metadata)

  parent_sb_id:
    command: sb_replace_files(I('5d88ea50e4b0c4f70d0ab3c0'), 'out/release.xml')

  config_sb_id:
    command: sb_replace_files(I('5d8a2257e4b0c4f70d0ae513'), 'out/glm_config.xml', 'out/glm_config.json')

  inputs_sb_id:
    command: sb_replace_files(I('5d89d90ce4b0c4f70d0ae4df'), 'out/inputs.xml','out/meteo_inputs.zip')

  train_parent_sb_id:
    command: sb_replace_files(I('5d8a42e3e4b0c4f70d0ae5fd'), 'out/training.xml')

  train_68_sb_id:
    command: sb_replace_files(I('5d8a47bce4b0c4f70d0ae61f'), 'out/training_all_historical.xml', 'out/all_lakes_historical_training.csv')

  train_sp_sb_id:
    command: sb_replace_files(I('5d8a4752e4b0c4f70d0ae61a'),
      'out/training_sparkling.xml',
      'out/sp_season_training.csv',
      'out/sp_similar_training.csv',
      'out/sp_year_training.csv')

  train_me_sb_id:
    command: sb_replace_files(I('5d8a837fe4b0c4f70d0ae8ac'),
      'out/training_mendota.xml',
      'out/me_season_training.csv',
      'out/me_similar_training.csv',
      'out/me_year_training.csv')

  # need me_predict .xml written and added...
  predict_me_sb_id:
    command: sb_replace_files(I('5d915cb2e4b0c4f70d0ce523'),
      'out/me_similar_predict_pgdl.csv',
      'out/me_similar_predict_dl.csv',
      'out/me_season_predict_pb.csv',
      'out/me_season_predict_pgdl.csv',
      'out/me_season_predict_dl.csv',
      'out/me_year_predict_pb.csv',
      'out/me_year_predict_pgdl.csv',
      'out/me_year_predict_dl.csv')

  # need me_predict .xml written and added...
  predict_sp_sb_id:
    command: sb_replace_files(I('5d915cc6e4b0c4f70d0ce525'),
      'out/sp_similar_predict_pb.csv',
      'out/sp_similar_predict_pgdl.csv',
      'out/sp_similar_predict_dl.csv',
      'out/sp_season_predict_pb.csv',
      'out/sp_season_predict_pgdl.csv',
      'out/sp_season_predict_dl.csv',
      'out/sp_year_predict_pb.csv',
      'out/sp_year_predict_pgdl.csv',
      'out/sp_year_predict_dl.csv')

  spatial_sb_id:
    command: sb_replace_files(I('5d89d8e3e4b0c4f70d0ae4dc'), 'out/spatial.xml', 'out/spatial.zip')

  evaluation_sb_id:
    command: sb_replace_files(I('5d925023e4b0c4f70d0d0594')) # and metadata...

  evaluation_sp_sb_id:
    command: sb_replace_files(I('5d92507be4b0c4f70d0d059b'))
